# 富文本编辑器2~复制粘贴的处理

# 业务场景分析

在编辑文章的过程中，复制粘贴是一个很常见的场景，一般会有2种情况。

#### 1 站外复制

用户的文章已经写好，并保存在第三方平台，比如微信公众平台、头条编辑平台、word中等。此时，用户会直接复制第三方平台中的文章，然后在我们的编辑器中直接粘贴。

最理想的情况是，将用户复制的文本、样式布局，及其包含的图片、音频、视频等内容全部能粘贴到编辑器中。

但这里面会有一些问题：

1. 样式布局，会自动被转成行内样式，如果在webview中展示没有问题，但我们需要显示到原生app页面中，是无法显示的
2. 图片，其实就是一个url连接，我们不能用这个url，因为这个url是站外的，很不安全，也很可能被防盗链拦住。【这里其实可以想办法把图片通过url下载下来，然后传到我们的平台中，然后图片就可以一键复制过来了】
3. 视频、音频，不同平台的实现不同，到我们这也不同，没法统一处理，并且，也存在防盗链的问题。

综上，从站外复制的内容，我们只能去掉其中的样式布局、图片等内容，只保留文本和段落信息。

#### 2 在编辑器中复制

用户编辑的过程中，可能希望通过编辑器调整文章内容的时候，会用到剪切粘贴，复制粘贴。这时候，我们必须做到内容中的样式布局，图片，视频，音频等内容都能原样保持不变。

# 相关事件、接口

会用到的事件有：

1. cut 剪切会触发
2. copy 复制会触发
3. paste 粘贴会触发

会用到的接口有：

1. clipboardData.getData('text/plain')以纯文本的形式，获得剪贴板里的数据
2. clipboardData.getData('text/html')以html的格式，获得剪贴板里的数据
2. window.getSelection 在复制的事件中，可以获得选中的内容
2. document.execCommand('insertText'，str) 把str作为text插入到编辑器中
3. document.execCommand('insertHTML', str) 把str作为html插入到编辑器中

# 站内站外的识别算法 --- 不完美算法1

首先，最重要的算法是，要能识别出来，本次粘贴，是从站外复制的内容，还是从站内复制的内容。

翻阅了mdn关于剪贴板、复制粘贴的相关接口，并没有接口或者事件能直接作出判断，所以得自己想办法，而我们的能用到的接口就是上面列举的。

所以，只想到了并不完美的算法，某些情况会失效。

1. 在编辑器中，监听cut和copy事件，并记录下复制或粘贴的字符串。
2. 在paste事件中，从剪贴板中获得当前要粘贴的字符串
3. 将两者进行比较，相等说明是站内，否则是站外

很明显，如果刚好站内先复制一个内容，然后去站外也复制一个内容，两个内容的字符串完全相等，判断就会产生错误，但这种情况发生的几率应该极低，所以，暂且忽略。

#### 一个大坑

某些情况会出现，算法失效的情况，后来发现和空格有关。

同样是看起来都一样的空格，但是有2种ASCII码，一个是160，一个是32，平时我们用的都是32，但是在复制的时候可能会产生160的，原因未知。

所以，在保存第一个字符串的时候，要将160的转成32的，否则判断会不准确。

```
const space160 = String.fromCharCode(160);
 const re = new RegExp(space160, 'g'); // 替换160的空格为正常32的空格 
this.lastCopyStr = window.getSelection().toString().replace(re, ' ');
```

# 站外数据的格式化

站外粘贴的时候，我们要从剪贴板获得纯文本的数据【clipboardData.getData('text/plain')】，然后调用document.execCommand('insertText'，str) 即可。

#### 解决图片alt问题 --- 不完美算法2

在从今日头条的文章中复制粘贴的时候，如果复制的内容中有图片，会将图片的alt的内容作为文本也复制进来。

如何去掉呢？

1. 通过clipboardData.getData('text/html')获得html信息，可以html信息，同时，可以通过正则来找出alt的内容都是什么。
2. 然后通过clipboardData.getData('text/html')获得纯文本信息，将第一步找到的alt的内容统统替换为空字符串。

产生的问题也很明显，如果文本中有和alt内容一致的内容，就会产生误操作。所以算法里增加了一项判断：

文本中，只出现一次alt的内容时才进行删除动作。

在这种极端情况下，用户就会把alt的内容也粘贴进来，但是，没什么大的影响，可以忽略。

# 站内数据的格式化

在站内复制粘贴的时候，某些浏览器会自动的往html标签上添加行内样式，很恶心。。。。。所以，站内的粘贴，我们要拦截paste事件，然后，从剪贴板中拿到要粘贴的内容【clipboardData.getData('text/html')】，去掉其中的行内样式，然后调用document.execCommand('insertHTML', str)即可。

# 心得

算法有时候并不完美，但只要满足了大部分的主要使用场景，也是可以使用的。

所以，在开发设计过程中，要能识别出主要场景，要尽量保证主要使用场景的功能，次要场景可以进行必要的忽略。

任何事物都是符合幂次定律的。牢记这一点，事半功倍！


